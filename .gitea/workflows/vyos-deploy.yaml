name: SSH and echo to file

on:
  push:
    branches: [ main ]
    paths: [ 'homelab/vyos/config.boot' ]

jobs:
  ssh:
    defaults:
      run: 
        working-directory: homelab/vyos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Jafner.net repo
        uses: actions/checkout@v4
      - name: Check network connectivity to host
        run: |
          sudo apt-get update &&\
          sudo apt-get install -y iputils-ping
          ping -c 1 -t 5 -q 192.168.1.1
      - name: Configure SSH
        run: |
          echo -e "${{ secrets.RUNNER_SSH_PRIVATEKEY }}" > /tmp/key
          chmod 600 /tmp/key
          ssh-keygen -y -f /tmp/key > /tmp/key.pub
          mkdir -p ~/.ssh && touch ~/.ssh/known_hosts && chmod 600 ~/.ssh/known_hosts
          ssh-keyscan -t ed25519 192.168.1.1 >> ~/.ssh/known_hosts
      - name: Connect to VyOS
        run: |
          ssh -i /tmp/key vyos@192.168.1.1 'whoami'
          SSH_CMD="ssh -i /tmp/key" SCP_CMD="scp -i /tmp/key -q" ./vyos.sh op show system image
          
      # - name: SSH into host
      #   uses: appleboy/ssh-action@v1.1.0
      #   with:
      #     host: 192.168.1.1
      #     username: vyos
      #     key: ${{ secrets.RUNNER_SSH_PRIVATEKEY }}
      #     debug: true
      #     script: |
      #       echo "$(date)" >> ~/hello.txt
