name: Build Nix Outputs
on:
  pull_request:
    types: [opened, reopened, synchronize]
jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v31
      - name: Install jq
        run: sudo apt-get install -y jq
      - name: Build configurations sequentially
        run: |
          set -euo pipefail
          echo "Getting NixOS configuration names from flake..."
          configs=$(nix eval --json .#nixosConfigurations --apply "x: builtins.attrNames x" | jq -r '.[]')

          any_failed=false
          for config in $configs; do
            echo "üöß Building configuration: $config"
            if nix build --no-link ".#nixosConfigurations.$config.config.system.build.toplevel"; then
              echo "‚úÖ Success: $config"
            else
              echo "‚ùå Failed: build for $config"
              any_failed=true
            fi
          done

          if [ "$any_failed" = true ]; then
            echo "üî• Some configurations failed to build"
            exit 1
          fi
