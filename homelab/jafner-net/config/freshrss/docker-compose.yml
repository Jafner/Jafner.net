version: '3'
services:
  freshrss:
    image: freshrss/freshrss:edge
    container_name: freshrss_freshrss
    logging:
      driver: loki
      options:
        loki-url: http://localhost:3100/loki/api/v1/push
        loki-batch-size: "50"
        loki-retries: "1"
        loki-timeout: "2s"
        keep-file: "true"
    restart: "no"
    depends_on: 
      - postgres
    networks:
      - freshrss
      - web
    volumes:
      - ${DOCKER_DATA}/freshrss/data:/var/www/FreshRSS/data
      - ${DOCKER_DATA}/freshrss/extensions:/var/www/FreshRSS/extensions
      - ./config.custom.php:/var/www/FreshRSS/data/config.custom.php
      - ./config-user.custom.php:/var/www/FreshRSS/config-user.custom.php
    env_file:
      - freshrss.env
      - freshrss_secrets.env
    labels:
      - traefik.http.routers.freshrss.rule=Host(`freshrss.jafner.net`)
      - traefik.http.routers.freshrss.tls.certresolver=lets-encrypt
      - traefik.http.routers.freshrss.tls.options=tls12@file
      - traefik.http.routers.freshrss.middlewares=securityheaders@file
      - traefik.http.services.freshrss.loadbalancer.server.port=8080

  postgres:
    image: postgres:15
    container_name: freshrss_postgres
    networks:
      - freshrss
    restart: "no"
    volumes:
      - ${DOCKER_DATA}/postgres:/var/lib/postgresql/data
    env_file:
      - postgres.env
      - postgres_secrets.env

networks:
  web:
    external: true
  freshrss: