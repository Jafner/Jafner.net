version: '3.9'
services:
  grafana:
    image: grafana/grafana-oss@sha256:b6ea013786be887c06d9664ad133f5300480f5c6b2f4586554d7c3b0756d9849
    container_name: monitoring_grafana
    restart: "no"
    networks:
      - monitoring
      - web
    user: "0"
    volumes:  
      - ${DOCKER_DATA}/grafana:/var/lib/grafana
      - ${DOCKER_DATA}/custom.ini:/etc/grafana/grafana.ini
    labels:
      - traefik.http.routers.grafana.rule=Host(`grafana.jafner.net`)
      - traefik.http.routers.grafana.tls.certresolver=lets-encrypt
      - traefik.http.routers.grafana.tls.options=tls12@file
      - traefik.http.routers.grafana.middlewares=securityheaders@file

  prometheus:
    image: prom/prometheus@sha256:8c01021bb2f4a685759ae4525aa2ea8460671a0412fd1bd58c205424c290a27e
    container_name: monitoring_prometheus
    user: 1001:1001
    networks:
      - monitoring
      - web
    ports:
      - 9090:9090
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ${DOCKER_DATA}/prometheus:/prometheus
    restart: "no"
    command:
      -   "--config.file=/etc/prometheus/prometheus.yml"
    labels:
      - traefik.http.routers.prometheus-monitoring.rule=Host(`prometheus.jafner.net`)
      - traefik.http.routers.prometheus-monitoring.tls.certresolver=lets-encrypt
      - traefik.http.routers.prometheus-monitoring.middlewares=traefik-forward-auth-privileged@file

  exporter-ping:
    image: czerwonk/ping_exporter@sha256:fe65bcfdc16243f6c6eb08edc3bfbc6a80d4fbb60a7e2814138b7014b9cafcf4
    container_name: monitoring_exporter-ping
    restart: "no"
    networks:
      - monitoring
    volumes:
      - ./exporter-ping/config.yml:/config/config.yml
  
  exporter-docker:
    image: prometheusnet/docker_exporter@sha256:f48aa98298fcde47edbd97f1c33534318a1f3e28ed9581f56fc2dcb4c3b21455
    container_name: monitoring_exporter-docker
    restart: "no"
    networks:
      - monitoring
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=false
  
  exporter-pihole:
    image: ekofr/pihole-exporter@sha256:f3ee4b32da43cdd10f12e57a95aab2bd43b9754d73c7394d5f6871a48668d96d
    container_name: monitoring_exporter-pihole
    env_file:
      - path: ./exporter-pihole.env
        required: true
      - path: ./exporter-pihole_secrets.env
        required: false
    restart: "no"
    networks:
      - monitoring
    labels:
      - traefik.enable=false

  uptime-kuma:
    image: louislam/uptime-kuma@sha256:e10376878b88fdeaa554b581695b99b5552fbbbb5344806046a859dcd3a2daf0
    container_name: monitoring_uptime-kuma
    restart: "no"
    volumes:
      - $DOCKER_DATA/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - web
    labels:
      - traefik.http.routers.uptime-kuma.rule=Host(`uptime.jafner.net`)
      - traefik.http.routers.uptime-kuma.tls.certresolver=lets-encrypt

networks:
  monitoring:
    external: true
  web:
    external: true
