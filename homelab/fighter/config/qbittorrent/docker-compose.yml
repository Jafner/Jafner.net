services:
  qbittorrent:
    image: linuxserver/qbittorrent:latest
    container_name: qbittorrent_qbittorrent
    deploy:
      resources:
        limits:
          memory: 6G
    network_mode: "service:gluetun"
    restart: "no"
    volumes:
      - $DOCKER_DATA:/config
      - $TORRENT_DATA:/torrenting
      - ./discord_notifier.sh:/discord_notifier.sh
      - ./discord_notifier_secrets.env:/discord_notifier_secrets.env
    environment:
      PUID: 1001
      PGID: 1001
      TZ: America/Los_Angeles
      WEBUI_PORT: 8080
    labels:
      - traefik.http.routers.qbt.rule=Host(`qbt.jafner.net`)
      - traefik.http.routers.qbt.tls.certresolver=lets-encrypt
      - traefik.http.routers.qbt.middlewares=traefik-forward-auth-privileged@file
      - traefik.http.routers.qbt-api.rule=Host(`api.qbt.jafner.net`)
      - traefik.http.routers.qbt-api.tls.certresolver=lets-encrypt
      - traefik.http.routers.qbt-api.middlewares=lan-only@file
      - traefik.http.services.qbt.loadbalancer.server.port=8080

  exporter-qbittorrent:
    image: esanchezm/prometheus-qbittorrent-exporter:latest
    container_name: qbittorrent_exporter
    environment:
      QBITTORRENT_HOST: http://qbittorrent
      QBITTORRENT_PORT: 8080
    restart: "no"
    networks:
      - monitoring
      - web
    labels:
      - traefik.enable=false

  gluetun:
    container_name: gluetun_gluetun
    image: qmcgaw/gluetun
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
    ports:
      - 8580:8080
    environment:
      VPN_SERVICE_PROVIDER: custom
      VPN_TYPE: wireguard
      WIREGUARD_ENDPOINT_IP: vpn.jafner.tools
      WIREGUARD_ENDPOINT_PORT: 53820
      WIREGUARD_PUBLIC_KEY: ${gluetun_WIREGUARD_PUBLIC_KEY}
      WIREGUARD_PRIVATE_KEY: ${gluetun_WIREGUARD_PRIVATE_KEY}
      WIREGUARD_PRESHARED_KEY: ${gluetun_WIREGUARD_PRESHARED_KEY}
      WIREGUARD_ADDRESSES: 10.8.0.9/24

networks:
  web:
    external: true
  monitoring:
    external: true
