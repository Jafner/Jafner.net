version: '3'
services:
  pihole:
    image: pihole/pihole
    container_name: pihole_pihole
    logging:
      driver: loki
      options:
        loki-url: http://localhost:3100/loki/api/v1/push
        loki-batch-size: "50"
        loki-retries: "1"
        loki-timeout: "2s"
        keep-file: "true"
    restart: "no"
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      WEBPASSWORD: ${SECRET_WEBPASSWORD}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      PIHOLE_DNS_: 8.8.8.8,8.8.4.4
      VIRTUAL_HOST: https://pihole.jafner.net
    volumes:
      - ${DOCKER_DATA}/pihole:/etc/pihole
      - ${DOCKER_DATA}/dnsmasq:/etc/dnsmasq.d
    labels:
      - traefik.http.routers.pihole.rule=Host(`pihole.jafner.net`)
      - traefik.http.routers.pihole.tls.certresolver=lets-encrypt
      - traefik.http.routers.pihole.middlewares=lan-only@file,pihole
      - traefik.http.services.pihole.loadbalancer.server.port=80
      - traefik.http.middlewares.pihole.addprefix.prefix=/admin
    networks:
      - web
      - monitoring
    ports:
      - "53:53/tcp"
      - "53:53/udp"
networks:
  web:
    external: true
  monitoring:
    external: true